# Logrotate configuration for Agrifrika Dashboard
# This file manages log rotation for all services

# Backend application logs
/app/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 appuser appuser
    copytruncate
    maxsize 50M

    postrotate
        # Send HUP signal to uvicorn to reopen log files
        docker exec agrifrika_backend pkill -HUP -f uvicorn 2>/dev/null || true
    endscript
}

# Nginx access and error logs
/var/log/nginx/*.log {
    daily
    rotate 52
    compress
    delaycompress
    missingok
    notifempty
    create 644 nginx nginx

    postrotate
        # Reload nginx to reopen log files
        docker exec agrifrika_nginx nginx -s reopen 2>/dev/null || true
    endscript
}

# Docker container logs (handled by docker daemon)
/var/lib/docker/containers/*/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    copytruncate
    maxsize 100M
}

# System-specific logs for the application
/var/log/agrifrika/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
    copytruncate

    # Clean old compressed logs
    postrotate
        find /var/log/agrifrika -name "*.gz" -mtime +30 -delete 2>/dev/null || true
    endscript
}

# Global settings
compress
compresscmd /bin/gzip
uncompresscmd /bin/gunzip
compressext .gz
compressoptions -9